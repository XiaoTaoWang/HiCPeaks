#!/usr/bin/env python

# Created on Fri Jun 29 19:26:12 2018
# Author: XiaoTao Wang

## Required modules

import argparse, sys, os, hicpeaks

currentVersion = hicpeaks.__version__

def getargs():
    ## Construct an ArgumentParser object for command-line arguments
    parser = argparse.ArgumentParser(description='''Perform Aggregate Peak Analysis (APA) on
                                     a peak list generated by our pyHICCUPS or pyBHFDR.''',
                                     formatter_class=argparse.ArgumentDefaultsHelpFormatter)
    
    # Version
    parser.add_argument('-v', '--version', action='version',
                        version=' '.join(['%(prog)s',currentVersion]),
                        help='Print version number and exit.')
    
    # Output
    parser.add_argument('-O', '--output', help='Output png file name.')
    parser.add_argument('--dpi', default=300, type=int,
                        help='''The resolution in dots per inch of the output figure.''')
    
    # Input
    parser.add_argument('-p', '--path',
                        help = 'URI string pointing to a cooler under specific resolution.')
    parser.add_argument('-I', '--loop-file', help='Loop file outputed by pyHICCUPS or pyBHFDR.')
    parser.add_argument('-U', '--useICE', action='store_true',
                        help='''Whether or not use ICE-corrected matrix.''')
    parser.add_argument('-M', '--min-dis', default=10, type=int,
                        help='''We only examine peak calls where the peak loci are separated by at
                        least this number of bins.''')
    parser.add_argument('-W', '--window', default=5, type=int,
                        help='''Width of the window in APA analysis.''')
    parser.add_argument('-C', '--corner-size', default=3, type=int,
                        help='''Lower-/upper-corner size of the resulted APA matrix.''')
    
    ## Parse the command-line arguments
    commands = sys.argv[1:]
    if not commands:
        commands.append('-h')
    args = parser.parse_args(commands)
    
    return args, commands


def run():

    # Parse Arguments
    args, commands = getargs()
    # Improve the performance if you don't want to run it
    if commands[0] not in ['-h', '-v', '--help', '--version']:

        from hicpeaks.apa import apa_analysis, apa_submatrix
        import cooler
        import matplotlib
        matplotlib.use('Agg')
        import matplotlib.pyplot as plt
        import numpy as np

        ## extract Hi-C matrix
        hic_pool = cooler.Cooler(args.hic)
        res = hic_pool.binsize
        correct = args.useICE

        # No further filtering during the test phase
        neopeaks = load_sv_peaks(args.sv_peaks, onlyInter=args.onlyInter)
        apa = []
        for region_id in neopeaks:
            _, c1, p1, s1, c2, p2, s2 = region_id.split(',')
            s_sub = neopeaks[region_id]
            p1, p2 = int(p1), int(p2)
            # consistent chromosome label
            pre = find_chrom_pre(hic_pool.chromnames)
            c1, c2 = pre+c1, pre+c2
            M, k_p, p1L, p1, p2, s1, s2 = get_matrix(hic_pool, c1, c2, p1, p2, s1, s2, radius, correct)
            c1, c2 = c1.lstrip(pre), c2.lstrip(pre)

            # construct map between genomic coordinates and local indices
            forward, _ = map_coordinates(k_p, res, c1, c2)

            Bool = np.zeros(M.shape, dtype=bool)
            for i in s_sub:
                orires = i[-1]
                # Lodate the peak pixel at finer resolution
                s_l = range(i[1]//res*res, int(np.ceil((i[1]+orires)/float(res)))*res, res)
                e_l = range(i[3]//res*res, int(np.ceil((i[3]+orires)/float(res)))*res, res)
                si, ei = None, None
                for ds in s_l:
                    for de in e_l:
                        if ((i[0],ds) in forward) and ((i[2],de) in forward):
                            st = forward[(i[0],ds)]
                            et = forward[(i[2],de)]
                            if si is None:
                                si, ei = st, et
                            else:
                                if M[st,et] > M[si,ei]:
                                    si, ei = st, et
                if not si is None:
                    if si < ei:
                        Bool[si, ei] = True
                    else:
                        Bool[ei, si] = True
                        
            tmp = apa_submatrix(M, Bool, p1L, w=args.window, t=args.min_dis)
            apa.extend(tmp)
        
        apa = np.r_[apa]
        avg, score, z, p, maxi = apa_analysis(apa, w=args.window, cw=args.corner_size)
        plt.imshow(avg, cmap=plt.cm.Reds, vmax=maxi, interpolation='none')
        plt.title('APA score = {0:.3g}, p-value = {1:.3g} ({2})'.format(score, p, apa.shape[0]))
        plt.colorbar()
        plt.savefig(args.output, dpi=args.dpi)
        plt.close()

if __name__ == '__main__':
    run()



